<!DOCTYPE html>
<html>

<head>
    <title>CoinMarketCap</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #fff;
            color: #1c1c1c;
            display: flex;
            padding: 20px;
        }

        header h1 {
            margin: 0;
        }

        header nav {
            display: flex;
            align-items: center;
        }

        header nav a {
            color: #1c1c1c;
            margin-left: 20px;
            text-decoration: none;
            font-family: Inter, -apple-system, BlinkMacSystemFont, segoe ui, Roboto, Helvetica, Arial, sans-serif;
            ;
        }

        main {
            margin: 20px;
        }

        main h2 {
            margin-top: 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #ddd;
        }

        .hDjzmZ {
            font-size: var(--c-font-size-100);
            font-weight: var(--c-font-weight-600);
            cursor: pointer;
        }

        .jyVQAz {
            height: 16px;
            width: 1px;
            margin: 0px 16px;
            background: rgb(207, 214, 228);
            flex-shrink: 0;
        }
    </style>
</head>

<body style="background-color: #fff;">
    <nav class="navbar navbar-expand-xxl pb-5">
        <div class="container-fluid">
            <img class="rounded-circle me-2" style="height: 50px;width: 50px;" src="../../img/logo.jpg">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-xxl-0">
                    <!-- <li class="nav-item">
                        <a class="nav-link active" aria-current="page"
                            href="../../html/page/home.html">Cryptocurrencies</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../html/page/dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../../html/page/coin_management.html">User coin</a>
                    </li> -->
                    <li class="nav-item">
                        <a class="nav-link" href="../../html/page/company.html">Company</a>
                    </li>
                </ul>
                <div class="dropdown p-2">
                    <div class="row p-2" style="display: none;" id="buttonLogin">
                        <a class="btn btn-primary" href="../../html/page/SignInSignUp.html">Login</a>
                    </div>
                    <div class="row" style="display: none;" id="menu">
                        <a class="align-items-center link-dark text-decoration-none" href="#" id="dropdownUser1"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="../../img/user.png" alt="Profile Picture" width="32" height="32"
                                class="rounded-circle me-2">
                            <span id="name"></span>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                            <li><a class="dropdown-item" href="../../html/user/user-profile.html"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-person-circle" viewBox="0 0 16 16">
                                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                                        <path fill-rule="evenodd"
                                            d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1" />
                                    </svg> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                                        height="16" fill="currentColor" class="bi bi-shield-lock" viewBox="0 0 16 16">
                                        <path
                                            d="M5.338 1.59a61 61 0 0 0-2.837.856.48.48 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.7 10.7 0 0 0 2.287 2.233c.346.244.652.42.893.533q.18.085.293.118a1 1 0 0 0 .101.025 1 1 0 0 0 .1-.025q.114-.034.294-.118c.24-.113.547-.29.893-.533a10.7 10.7 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.8 11.8 0 0 1-2.517 2.453 7 7 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7 7 0 0 1-1.048-.625 11.8 11.8 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 63 63 0 0 1 5.072.56" />
                                        <path
                                            d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415" />
                                    </svg> Change Password</a></li>
                            <li><button class="dropdown-item" id="logoutButton"><svg xmlns="http://www.w3.org/2000/svg"
                                        width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right"
                                        viewBox="0 0 16 16">
                                        <path fill-rule="evenodd"
                                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                                        <path fill-rule="evenodd"
                                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                                    </svg> Logout</button></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="container" style="background-color: #fff;">



        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">
                            Coin management</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" name="" id="coin_id" hidden>
                        <div id="select_coin">
                            <label>
                                Coin
                            </label>
                            <select id="coinmarket_id" class="form-control">

                            </select>
                        </div>

                        <div>
                            <label>Quantity</label>
                            <input type="number" name="" id="quantity" class="form-control" step="0.000001">
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="saveOrUpdate()" class="btn btn-success">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update modal -->



        <main>
            <div class="row py-2" style="display: flex;">
                <div class="col-md-8">
                    <button class="btn border btn-light" style="background-color: #FFF;" type="button"
                        data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="setNull()">
                        <svg viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg" height="1em"
                            width="1em" class="sc-f70bb44c-0 fDjslW c-i" loading="lazy">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M5.80195 9.1961V5.79609H9.20196V9.1961H5.80195ZM4.00195 5.49609C4.00195 4.66767 4.67352 3.99609 5.50195 3.99609H9.50196C10.3304 3.99609 11.002 4.66767 11.002 5.49609V9.4961C11.002 10.3245 10.3304 10.9961 9.50196 10.9961H5.50195C4.67352 10.9961 4.00195 10.3245 4.00195 9.4961V5.49609ZM14.802 9.1961V5.79609H18.2019V9.1961H14.802ZM13.002 5.49609C13.002 4.66767 13.6735 3.99609 14.502 3.99609H18.5019C19.3303 3.99609 20.0019 4.66767 20.0019 5.49609V9.4961C20.0019 10.3245 19.3303 10.9961 18.5019 10.9961H14.502C13.6735 10.9961 13.002 10.3245 13.002 9.4961V5.49609ZM14.802 14.7961V18.1961H18.2019V14.7961H14.802ZM14.502 12.9961C13.6735 12.9961 13.002 13.6677 13.002 14.4961V18.4961C13.002 19.3245 13.6735 19.9961 14.502 19.9961H18.5019C19.3303 19.9961 20.0019 19.3245 20.0019 18.4961V14.4961C20.0019 13.6677 19.3303 12.9961 18.5019 12.9961H14.502ZM5.80195 18.1961V14.7961H9.20196V18.1961H5.80195ZM4.00195 14.4961C4.00195 13.6677 4.67352 12.9961 5.50195 12.9961H9.50196C10.3304 12.9961 11.002 13.6677 11.002 14.4961V18.4961C11.002 19.3245 10.3304 19.9961 9.50196 19.9961H5.50195C4.67352 19.9961 4.00195 19.3245 4.00195 18.4961V14.4961Z"
                                fill="currentColor"></path>
                        </svg> <b style="font-size: 12px;">Add coin</b></button>

                </div>

            </div>
            <table id="cryptoTable">
                <thead>
                    <tr>

                        <th>Name</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>

                        </th>

                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <script type="module">
        import { instance } from "../../axios/config/config.js";
        const baseURL = instance.defaults.baseURL;
        const apiProfile = baseURL + 'v1/user/own';
        const apiUrl = baseURL + 'v1/coins/find-by-user-logged';

        const headers = {
            'Authorization': 'Bearer ' + getCookie('token'),
        };

        // hiển thị menu và nut login
        document.addEventListener("DOMContentLoaded", function () {
            var buttonLogin = document.getElementById("buttonLogin");
            var menu = document.getElementById("menu");
            // Kiểm tra xem cookie có tồn tại không
            var cookieExists = getCookie('token');
            // Nếu cookie không tồn tại, hiển thị phần tử loginContainer
            if (!cookieExists) {
                buttonLogin.style.display = "block";
            } else {
                menu.style.display = "block";
            }
        });


        // if( getCookie('accessToken')){}
        populateCoinOptions()

        window.saveOrUpdate = function () {

            const selectedOption = $('#coinmarket_id option:selected');

            // Retrieve values from the selected option


            const id = $('#coin_id').val()
            const coinmarketId = selectedOption.val();
            const name = selectedOption.text();
            const symbol = selectedOption.data('symbol');
            const quantity = $("#quantity").val();


            const coinData = {

                coinmarketId: coinmarketId,
                name: name,
                symbol: symbol,
                quantity: quantity
            };

            var url = '';

            if (id) {

                url = baseURL + 'v1/coins/' + id;
                // coinData.id=null;

                updateCoin(url, coinData);
            } else {
                url = baseURL + 'v1/coins';
                addToCoin(url, coinData);
            }

        }

        window.addToCoin = function (url, coinData) {
            axios.post(url, coinData, { headers })
                .then(res => {
                    fetchDataAndPopulateTable(apiUrl)

                    setNull()

                    Swal.fire({
                        title: "Thông báo!",
                        text: res.data,
                        icon: "success",
                    });

                }).catch(err => {
                    console.log(err)
                    if (err.response) {
                        Swal.fire({
                            title: "Thông báo!",
                            text: err.response.data.message,
                            icon: "error",
                        });
                    } else {
                        Swal.fire({
                            title: "Thông báo!",
                            text: err,
                            icon: "error",
                        });
                    }
                })
        }

        window.updateCoin = function (url, coinData) {
            axios.put(url, coinData, { headers })
                .then(res => {
                    fetchDataAndPopulateTable(apiUrl)


                    setNull()

                    Swal.fire({
                        title: "Thông báo!",
                        text: res.data,
                        icon: "success",
                    });

                }).catch(err => {
                    console.log(err)
                    if (err.response) {
                        Swal.fire({
                            title: "Thông báo!",
                            text: err.response.data.message,
                            icon: "error",
                        });
                    } else {
                        Swal.fire({
                            title: "Thông báo!",
                            text: err,
                            icon: "error",
                        });
                    }
                })
        }

        window.deleteCoin = function (id) {

            Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {

                    axios.delete(baseURL + 'v1/coins/' + id, { headers })
                        .then(res => {
                            Swal.fire({
                                title: "Deleted!",
                                text: res.data,
                                icon: "success"
                            });

                            fetchDataAndPopulateTable(apiUrl)
                        })


                }
            });
        }


        window.setNull = function () {
            $('#select_coin').show()
            $('#coinmarket_id').val(1)
            $('#coin_id').val("")
            $('#quantity').val(1)
            $('#exampleModal').modal('hide');
        }
        window.findById = function (id) {
            axios.get(baseURL + 'v1/coins/' + id, { headers })
                .then(res => {

                    // console.log(res)
                    $('#coinmarket_id').val(res.data.coinmarketId)
                    $('#coin_id').val(res.data.id)
                    $('#quantity').val(res.data.quantity)

                    $('#select_coin').hide()
                    $('#exampleModal').modal('show')
                })
        }


        function populateCoinOptions() {
            const selectElement = $('#coinmarket_id');

            axios.get(baseURL + 'v1/coins/home')
                .then(response => {
                    if (response.status !== 200) {
                        throw new Error(`Error: ${response.status}`);
                    }
                    return response.data;
                })
                .then(data => {
                    // Assuming data is an array of objects with 'id' and 'name' properties

                    selectElement.empty().append(
                        data.data.data.cryptoCurrencyList.map(option => $('<option>', {
                            value: option.id,
                            text: option.name,

                            'data-symbol': option.symbol
                        }))
                    );
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }


        // Hàm fetch dữ liệu và điền vào bảng
        function fetchDataAndPopulateTable(apiUrl) {
            axios.get(apiUrl, { headers })
                .then(response => {
                    if (response.status !== 200) {
                        throw new Error(`Error: ${response.status}`);
                    }
                    return response.data;
                })
                .then(data => {
                    console.log(data);
                    populateTable(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    if (err.response) {
                        Swal.fire({
                            title: "Thông báo!",
                            text: err.response.data.message,
                            icon: "error",
                        });
                    } else {
                        Swal.fire({
                            title: "Thông báo!",
                            text: err,
                            icon: "error",
                        });
                    }
                });
        }

        // Gọi hàm lần đầu
        fetchDataAndPopulateTable(apiUrl);

        function populateTable(data) {
            const tableBody = document.getElementById('cryptoTable').getElementsByTagName('tbody')[0];
            // Xóa dữ liệu hiện tại trên bảng
            tableBody.innerHTML = '';

            const mapping = {

                'name': crypto => `<img src="https://s2.coinmarketcap.com/static/img/coins/64x64/${crypto.coinmarketId}.png" style="width: 24px; height: 24px;"> <strong>${crypto.name}</strong> <span style="color: rgb(128, 138, 157);">${crypto.symbol}</span>`,
                'price': crypto => `<strong>$ ${crypto.price.toLocaleString()}</strong>`,
                'quantity': crypto => `<strong>${crypto.quantity}</strong>`,
                'total': crypto => `<strong>$ ${(crypto.price * crypto.quantity).toLocaleString()}</strong`,
                'action': crypto => `
                <button onclick="findById(${crypto.id})" class="btn btn-warning">Edit</button>
                 <button onclick="deleteCoin(${crypto.id})" class="btn btn-danger">Delete</button>
                `

            };

            data.forEach(crypto => {
                const row = tableBody.insertRow();

                Object.keys(mapping).forEach((key, index) => {
                    const cell = row.insertCell(index);
                    const label = key;
                    const value = mapping[key](crypto);
                    cell.innerHTML = `${value}`;
                });
            });

            if (data.length === 0) {
                tableBody.innerHTML = '<td colspan="5" class="text-center"><b>No coins have been added to your account yet.</b></td>';
            }
        }


        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        };

        function profile(apiUrl) {
            var authToken = getCookie('token');
            var name = document.getElementById('name');
            const requestConfig = {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                }
            };
            axios.get(apiUrl, requestConfig)
                .then(response => {
                    if (response.status !== 200) {
                        throw new Error(`Error: ${response.status}`);
                    }
                    return response.data;
                })
                .then(data => {
                    var profile = data;
                    name.textContent = profile.data.name;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function logout() {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                var eqPos = cookie.indexOf("=");
                var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            }
            window.location.href = window.location.origin + "/html/page/SignInSignUp.html"; // Thay đổi đường dẫn nếu cần
        }

        document.getElementById("logoutButton").addEventListener("click", function () {
            logout();
        });
        if (getCookie('token') != null) {
            profile(apiProfile);
        }
    </script>
</body>

</html>