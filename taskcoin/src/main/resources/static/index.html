<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View UI Coin Market</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="//cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <a href="#" class="home">
            <img src="image/bitcoin-7809_128.gif" alt="HOME" title="Trang chủ">
        </a>
        <div class="login-register-group">
            <a href="../static/Login.html" class="login-text">Login</a>
            <a href="../static/register.html" class="register-text">Register</a>
        </div>
    </nav>

    <div class="container mt-5" style="width: 100%">
        <table id="coin-table" class="table table-striped table-hover">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Price</th>
                <th scope="col">1h %</th>
                <th scope="col">24h %</th>
                <th scope="col">7d %</th>
                <th scope="col">Market Cap</th>
                <th scope="col">Volume(24h)</th>
                <th scope="col">Circulating Supply</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>


</body>
</html>

<script>
    $(document).ready(function () {
        let gSTT = 1;

        let vTable = $("#coin-table").DataTable({

            columns: [
                {
                    data: null, render: function (data, type, row) {
                        return gSTT++;
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <div class="d-flex  align-items-center">
                                <div>
                                    <img src="https://s2.coinmarketcap.com/static/img/coins/32x32/${data.id}.png" alt="" class="coin-logo">
                                </div>
                                <div style="margin-left:10px">
                                    <div>${data.name}</div>
                                    <div class="text-black-50">${data.symbol}</div>
                                </div>
                            </div>
                        `;
                    }
                },
                {data: "quotes[0].price"},
                {data: "quotes[0].percentChange1h"},
                {data: "quotes[0].percentChange24h"},
                {data: "quotes[0].percentChange7d"},
                {data: "quotes[0].marketCap"},
                {data: "quotes[0].volume24h"},
                {
                    data: null,
                    render: function (data, type, row) {
                        let numericData = parseFloat(data.circulatingSupply);
                        let formattedNumber = numericData.toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0,
                        });
                        return formattedNumber + " " + data.symbol;
                    }
                },
            ],
            columnDefs: [
                {targets: [0, 1, 2, 3, 4, 5, 6, 7, 8], orderable: false, className: "fw-bold align-middle"},
                {
                    targets: [2, 6, 7],
                    render: function (data) {
                        let numericData = parseFloat(data);
                        let formattedNumber = numericData.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2,
                        });
                        return "$" + formattedNumber;
                    },
                },
                {
                    targets: [3, 4, 5],
                    render: function (data) {
                        let numericData = parseFloat(data);
                        let formattedNumber = numericData.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2,
                        });
                        let textColor = "";
                        let icon;
                        if (numericData >= 0) {
                            textColor = "green";
                            icon = '<i class="fa-solid fa-caret-up"></i>';
                        } else if (numericData < 0) {
                            textColor = "red";
                            icon = '<i class="fa-solid fa-caret-down"></i>';
                        }
                        let absoluteValue = Math.abs(formattedNumber);
                        return `<span style="color:${textColor}">${icon} ${absoluteValue}%</span>`;
                    },
                },
            ],
        });

        // Gọi hàm onPageLoading khi trang được tải
        onPageLoading();

        function onPageLoading() {
            // Gọi hàm loadTable lần đầu tiên ngay khi trang được tải
            loadTable("http://localhost:8080/api/coinmarketcap?start=1&limit=100&sortBy=market_cap&sortType=desc&convert=USD");

            // Sử dụng setTimeout để chờ 30 giây trước khi gọi lại hàm loadTable
            setInterval(function () {
                loadTable("http://localhost:8080/api/coinmarketcap?start=1&limit=100&sortBy=market_cap&sortType=desc&convert=USD");
            }, 60000);
        }

        function loadTable(paramUrl) {
            gSTT = 1;

            $.ajax({
                url: paramUrl,
                dataType: 'json',
                success: function (json) {
                    console.log(json)
                    let newData = json.data.cryptoCurrencyList;

                    // Use clear() to remove existing data and rows.add() to add new data
                    vTable.clear().rows.add(newData).draw();

                    // Optionally, you can adjust other table configurations or UI here
                    // For example, if you want to update column rendering based on new data
                    vTable.columns.adjust();
                },
                error: function (error) {
                    console.error("Error loading table data:", error);
                }
            });
        }
    });
</script>

<style>
    .coin-logo {
        height: 24px;
        width: 24px;
    }
</style>